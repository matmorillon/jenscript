<script type="text/javascript">
	/**
	 * WorkerQueue.js
	 * Class to handle long-running, asynchronous tasks.
	 */
	WorkerQueue = function(frequency) {
		this.queue = [];
		this.timeout = 0;
		this.current = null;
		this.frequency = frequency;
		
		this.pop = function() {
			console.log('pop '+new Date()); 
			if (!this.current) {
				if (!this.queue.length) {
					window.clearInterval(this.timeout);
					this.timeout = 0;
					return;
				}
				this.current = this.queue.shift();
			}
			if (this.current()) {
				this.current = null;
			}
		}
		
		this.push = function(task) {
			var self = this;
			this.queue.push(task);
			if (!this.timeout) {
				this.timeout = window.setInterval(function() {
					self.pop();
				}, this.frequency);
			}
			this.pop();
		}
	}
</script>


<script>
	window.onload = function() {
		
		var Task = function() {
			this.run = function() {
				console.log('start task');
				for (var i = 0; i < 100; i++) {
					console.log("work.."+i);
				}
				console.log('end task');
			}
		}
		
		var q1 = new WorkerQueue(2000);
		
		var t1 = new Task();
		q1.push(function() {
			return t1.run()
		});

	}
</script>